<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Domain Radar</title>
<style>
  :root {
    --bg: #0d1117;
    --card: #161b22;
    --border: #30363d;
    --text: #e6edf3;
    --text-dim: #8b949e;
    --accent: #58a6ff;
    --green: #3fb950;
    --yellow: #d29922;
    --red: #f85149;
    --mono: 'SF Mono', 'Cascadia Code', 'Fira Code', Consolas, monospace;
    --sans: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { background: var(--bg); color: var(--text); font-family: var(--sans); min-height: 100vh; }

  /* Password Gate */
  #gate {
    display: flex; align-items: center; justify-content: center;
    min-height: 100vh; flex-direction: column; gap: 24px;
  }
  #gate h1 { font-size: 24px; color: var(--accent); letter-spacing: 2px; }
  #gate .subtitle { color: var(--text-dim); font-size: 13px; }
  #gate .login-box {
    background: var(--card); border: 1px solid var(--border); border-radius: 12px;
    padding: 32px; display: flex; flex-direction: column; gap: 16px; width: 360px;
  }
  #gate input {
    background: var(--bg); border: 1px solid var(--border); border-radius: 6px;
    padding: 12px 14px; color: var(--text); font-size: 14px; outline: none;
    font-family: var(--mono); letter-spacing: 2px;
  }
  #gate input:focus { border-color: var(--accent); }
  #gate button {
    background: var(--accent); color: #fff; border: none; border-radius: 6px;
    padding: 12px; font-size: 14px; font-weight: 600; cursor: pointer;
  }
  #gate button:hover { opacity: 0.9; }
  #gate .error { color: var(--red); font-size: 13px; text-align: center; display: none; }
  #gate .lock { font-size: 32px; margin-bottom: 8px; }

  /* Dashboard */
  #dashboard { display: none; max-width: 1200px; margin: 0 auto; padding: 24px 16px; }

  .header {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 24px; flex-wrap: wrap; gap: 12px;
  }
  .header h1 { font-size: 22px; color: var(--accent); display: flex; align-items: center; gap: 10px; }
  .status-dot {
    width: 10px; height: 10px; border-radius: 50%; display: inline-block;
    background: var(--text-dim);
  }
  .status-dot.running { background: var(--green); box-shadow: 0 0 8px var(--green); animation: pulse 2s infinite; }
  @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.5; } }
  .header-actions { display: flex; gap: 8px; }
  .btn {
    background: var(--card); border: 1px solid var(--border); border-radius: 6px;
    padding: 6px 14px; color: var(--text); font-size: 13px; cursor: pointer;
  }
  .btn:hover { border-color: var(--accent); color: var(--accent); }

  .status-bar {
    background: var(--card); border: 1px solid var(--border); border-radius: 8px;
    padding: 14px 20px; margin-bottom: 20px;
    display: flex; flex-wrap: wrap; gap: 24px; font-size: 13px; color: var(--text-dim);
  }
  .status-bar span { display: flex; align-items: center; gap: 6px; }
  .status-bar strong { color: var(--text); }

  .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 20px; }
  .stat-card {
    background: var(--card); border: 1px solid var(--border); border-radius: 8px;
    padding: 20px;
  }
  .stat-card .label { font-size: 12px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px; }
  .stat-card .value { font-size: 28px; font-weight: 700; font-family: var(--mono); }
  .stat-card .value.green { color: var(--green); }
  .tld-badges { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 10px; }
  .tld-badge {
    background: var(--bg); border: 1px solid var(--border); border-radius: 12px;
    padding: 2px 10px; font-size: 12px; font-family: var(--mono); color: var(--text-dim);
  }

  .filters {
    background: var(--card); border: 1px solid var(--border); border-radius: 8px;
    padding: 14px 20px; margin-bottom: 20px;
    display: flex; flex-wrap: wrap; gap: 12px; align-items: center;
  }
  .filters label { font-size: 12px; color: var(--text-dim); }
  .filters select, .filters input[type="text"] {
    background: var(--bg); border: 1px solid var(--border); border-radius: 6px;
    padding: 6px 10px; color: var(--text); font-size: 13px; outline: none;
  }
  .filters select:focus, .filters input:focus { border-color: var(--accent); }
  .filter-group { display: flex; flex-direction: column; gap: 4px; }

  .table-wrap {
    background: var(--card); border: 1px solid var(--border); border-radius: 8px;
    overflow-x: auto;
  }
  table { width: 100%; border-collapse: collapse; font-size: 14px; }
  th {
    text-align: left; padding: 12px 16px; border-bottom: 1px solid var(--border);
    font-size: 12px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.5px;
    cursor: pointer; user-select: none; white-space: nowrap;
  }
  th:hover { color: var(--accent); }
  th .sort-arrow { margin-left: 4px; font-size: 10px; }
  td { padding: 10px 16px; border-bottom: 1px solid var(--border); }
  tr:last-child td { border-bottom: none; }
  tr:hover td { background: rgba(88,166,255,0.04); }
  .domain-cell { font-family: var(--mono); color: var(--green); font-weight: 500; }
  .premium-tag {
    background: var(--yellow); color: #000; font-size: 10px; font-weight: 700;
    padding: 1px 6px; border-radius: 4px; margin-left: 6px;
  }
  .dim { color: var(--text-dim); }
  .empty-state { text-align: center; padding: 48px; color: var(--text-dim); }
  .decrypt-error { color: var(--red); text-align: center; padding: 20px; font-size: 13px; }

  @media (max-width: 640px) {
    .stats { grid-template-columns: 1fr 1fr; }
    .filters { flex-direction: column; }
    .header { flex-direction: column; align-items: flex-start; }
  }
</style>
</head>
<body>

<div id="gate">
  <div class="lock">&#x1F6E1;</div>
  <h1>DOMAIN RADAR</h1>
  <div class="subtitle">End-to-end encrypted. Enter your key to decrypt.</div>
  <div class="login-box">
    <input type="password" id="pw" placeholder="Decryption key" autocomplete="off">
    <button onclick="tryLogin()">Decrypt &amp; Enter</button>
    <div class="error" id="pw-error">Decryption failed. Wrong key.</div>
  </div>
</div>

<div id="dashboard">
  <div class="header">
    <h1>
      <span class="status-dot" id="statusDot"></span>
      Domain Radar
    </h1>
    <div class="header-actions">
      <button class="btn" onclick="refreshData()">Refresh Data</button>
      <button class="btn" onclick="logout()">Lock</button>
    </div>
  </div>

  <div class="status-bar" id="statusBar">
    <span>Status: <strong id="statusText">Loading...</strong></span>
  </div>

  <div class="stats">
    <div class="stat-card">
      <div class="label">Domains Checked</div>
      <div class="value" id="statChecked">--</div>
    </div>
    <div class="stat-card">
      <div class="label">Domains Found</div>
      <div class="value green" id="statFound">--</div>
    </div>
    <div class="stat-card">
      <div class="label">Found by TLD</div>
      <div class="tld-badges" id="tldBadges"></div>
    </div>
  </div>

  <div class="filters">
    <div class="filter-group">
      <label>Search</label>
      <input type="text" id="filterSearch" placeholder="domain name..." oninput="renderTable()">
    </div>
    <div class="filter-group">
      <label>TLD</label>
      <select id="filterTld" onchange="renderTable()"><option value="">All</option></select>
    </div>
    <div class="filter-group">
      <label>Strategy</label>
      <select id="filterStrategy" onchange="renderTable()"><option value="">All</option></select>
    </div>
    <div class="filter-group">
      <label>Max Price</label>
      <input type="text" id="filterMaxPrice" placeholder="e.g. 50" oninput="renderTable()" style="width:80px">
    </div>
  </div>

  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th onclick="sortBy('domain')">Domain <span class="sort-arrow" id="sort-domain"></span></th>
          <th onclick="sortBy('strategy')">Strategy <span class="sort-arrow" id="sort-strategy"></span></th>
          <th onclick="sortBy('price')">Price <span class="sort-arrow" id="sort-price"></span></th>
          <th onclick="sortBy('tld')">TLD <span class="sort-arrow" id="sort-tld"></span></th>
          <th onclick="sortBy('checkedAt')">Found <span class="sort-arrow" id="sort-checkedAt"></span></th>
        </tr>
      </thead>
      <tbody id="resultsBody"></tbody>
    </table>
  </div>
</div>

<script>
// --- AES-256-GCM Decryption ---
let userPassword = null;

function b64decode(str) {
  return Uint8Array.from(atob(str), c => c.charCodeAt(0));
}

async function deriveKey(password, salt) {
  const enc = new TextEncoder();
  const keyMaterial = await crypto.subtle.importKey('raw', enc.encode(password), 'PBKDF2', false, ['deriveKey']);
  return crypto.subtle.deriveKey(
    { name: 'PBKDF2', salt, iterations: 100000, hash: 'SHA-256' },
    keyMaterial,
    { name: 'AES-GCM', length: 256 },
    false,
    ['decrypt']
  );
}

async function decryptData(encObj, password) {
  const salt = b64decode(encObj.salt);
  const iv = b64decode(encObj.iv);
  const ciphertextWithTag = b64decode(encObj.data);
  const key = await deriveKey(password, salt);
  const decrypted = await crypto.subtle.decrypt({ name: 'AES-GCM', iv }, key, ciphertextWithTag);
  return JSON.parse(new TextDecoder().decode(decrypted));
}

// --- Auth ---
async function tryLogin() {
  const pw = document.getElementById('pw').value;
  if (!pw) return;

  try {
    // Try to decrypt status first as a test
    const statusRes = await fetch('data/status.enc.json?t=' + Date.now());
    if (!statusRes.ok) {
      // No encrypted data yet — accept any password
      userPassword = pw;
      sessionStorage.setItem('rk', pw);
      showDashboard();
      return;
    }
    const encStatus = await statusRes.json();
    await decryptData(encStatus, pw);

    // Decryption succeeded — password is correct
    userPassword = pw;
    sessionStorage.setItem('rk', pw);
    showDashboard();
  } catch {
    document.getElementById('pw-error').style.display = 'block';
  }
}

document.getElementById('pw').addEventListener('keydown', e => { if (e.key === 'Enter') tryLogin(); });

function logout() {
  sessionStorage.removeItem('rk');
  userPassword = null;
  location.reload();
}

function showDashboard() {
  document.getElementById('gate').style.display = 'none';
  document.getElementById('dashboard').style.display = 'block';
  refreshData();
}

// --- Data ---
let resultsData = [];
let statusData = {};
let currentSort = { key: 'checkedAt', asc: false };

async function refreshData() {
  if (!userPassword) return;

  try {
    const [resRes, statRes] = await Promise.allSettled([
      fetch('data/results.enc.json?t=' + Date.now()),
      fetch('data/status.enc.json?t=' + Date.now()),
    ]);

    if (resRes.status === 'fulfilled' && resRes.value.ok) {
      const enc = await resRes.value.json();
      resultsData = await decryptData(enc, userPassword);
    }
    if (statRes.status === 'fulfilled' && statRes.value.ok) {
      const enc = await statRes.value.json();
      statusData = await decryptData(enc, userPassword);
    }
  } catch (e) {
    console.error('Decrypt/fetch error:', e);
  }
  renderAll();
}

function renderAll() {
  renderStatus();
  renderStats();
  renderFilters();
  renderTable();
}

function renderStatus() {
  const dot = document.getElementById('statusDot');
  const bar = document.getElementById('statusBar');
  const running = statusData.running === true;

  dot.className = 'status-dot' + (running ? ' running' : '');

  let html = `<span>Status: <strong>${running ? 'Scanning' : 'Idle'}</strong></span>`;
  if (statusData.lastCompleted) {
    html += `<span>Last scan: <strong>${formatTime(statusData.lastCompleted)}</strong></span>`;
  }
  if (statusData.lastCompleted) {
    const next = new Date(new Date(statusData.lastCompleted).getTime() + 3600000);
    html += `<span>Next scan: <strong>${formatTime(next.toISOString())}</strong></span>`;
  }
  if (statusData.runDuration) {
    html += `<span>Duration: <strong>${statusData.runDuration}s</strong></span>`;
  }
  bar.innerHTML = html;
}

function formatTime(iso) {
  if (!iso) return '--';
  const d = new Date(iso);
  return d.toLocaleString(undefined, { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
}

function renderStats() {
  document.getElementById('statChecked').textContent = (statusData.domainsChecked ?? 0).toLocaleString();
  document.getElementById('statFound').textContent = resultsData.length.toLocaleString();

  const tldCounts = {};
  for (const r of resultsData) {
    const tld = r.tld || ('.' + r.domain.split('.').pop());
    tldCounts[tld] = (tldCounts[tld] || 0) + 1;
  }
  const badges = Object.entries(tldCounts)
    .sort((a, b) => b[1] - a[1])
    .map(([tld, n]) => `<span class="tld-badge">${tld} ${n}</span>`)
    .join('');
  document.getElementById('tldBadges').innerHTML = badges || '<span style="color:var(--text-dim)">Waiting for first scan...</span>';
}

function renderFilters() {
  const tlds = [...new Set(resultsData.map(r => r.tld || ('.' + r.domain.split('.').pop())))].sort();
  const strategies = [...new Set(resultsData.map(r => r.strategy))].sort();

  const tldSelect = document.getElementById('filterTld');
  const currentTld = tldSelect.value;
  tldSelect.innerHTML = '<option value="">All</option>' + tlds.map(t => `<option value="${t}">${t}</option>`).join('');
  tldSelect.value = currentTld;

  const stratSelect = document.getElementById('filterStrategy');
  const currentStrat = stratSelect.value;
  stratSelect.innerHTML = '<option value="">All</option>' + strategies.map(s => `<option value="${s}">${s}</option>`).join('');
  stratSelect.value = currentStrat;
}

function parsePrice(priceStr) {
  if (!priceStr) return 0;
  const m = priceStr.match(/(\d+(?:\.\d+)?)/);
  return m ? parseFloat(m[1]) : 0;
}

function getFiltered() {
  const search = document.getElementById('filterSearch').value.toLowerCase();
  const tld = document.getElementById('filterTld').value;
  const strategy = document.getElementById('filterStrategy').value;
  const maxPriceStr = document.getElementById('filterMaxPrice').value;
  const maxPrice = maxPriceStr ? parseFloat(maxPriceStr) : Infinity;

  return resultsData.filter(r => {
    if (search && !r.domain.toLowerCase().includes(search)) return false;
    const rTld = r.tld || ('.' + r.domain.split('.').pop());
    if (tld && rTld !== tld) return false;
    if (strategy && r.strategy !== strategy) return false;
    if (parsePrice(r.price) > maxPrice) return false;
    return true;
  });
}

function sortBy(key) {
  if (currentSort.key === key) {
    currentSort.asc = !currentSort.asc;
  } else {
    currentSort = { key, asc: true };
  }
  renderTable();
}

function renderTable() {
  for (const col of ['domain', 'strategy', 'price', 'tld', 'checkedAt']) {
    const el = document.getElementById('sort-' + col);
    if (col === currentSort.key) {
      el.textContent = currentSort.asc ? '\u25B2' : '\u25BC';
    } else {
      el.textContent = '';
    }
  }

  let data = getFiltered();
  const { key, asc } = currentSort;
  data.sort((a, b) => {
    let va, vb;
    if (key === 'price') {
      va = parsePrice(a.price); vb = parsePrice(b.price);
    } else if (key === 'tld') {
      va = a.tld || ('.' + a.domain.split('.').pop());
      vb = b.tld || ('.' + b.domain.split('.').pop());
    } else {
      va = a[key] ?? ''; vb = b[key] ?? '';
    }
    if (va < vb) return asc ? -1 : 1;
    if (va > vb) return asc ? 1 : -1;
    return 0;
  });

  const tbody = document.getElementById('resultsBody');
  if (data.length === 0) {
    tbody.innerHTML = '<tr><td colspan="5" class="empty-state">No domains found yet. Waiting for scan results...</td></tr>';
    return;
  }

  tbody.innerHTML = data.map(r => {
    const tld = r.tld || ('.' + r.domain.split('.').pop());
    const premium = r.premium ? '<span class="premium-tag">PREMIUM</span>' : '';
    const date = r.checkedAt ? formatTime(r.checkedAt) : '--';
    return `<tr>
      <td class="domain-cell">${esc(r.domain)}${premium}</td>
      <td class="dim">${esc(r.strategy)}</td>
      <td>${esc(r.price)}</td>
      <td class="dim">${esc(tld)}</td>
      <td class="dim">${date}</td>
    </tr>`;
  }).join('');
}

function esc(s) {
  if (!s) return '';
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

// --- Init ---
const savedKey = sessionStorage.getItem('rk');
if (savedKey) {
  userPassword = savedKey;
  showDashboard();
}
</script>
</body>
</html>
